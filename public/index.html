<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Mobile App LEGARANT</title>
	<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
	<script src="//code.jquery.com/jquery-1.11.3.min.js"></script>
	<style>
		body {
			padding-top: 60px;
		}
	</style>
	<script>
		var contactId;

		$(function () {
			var contactInformationForm = $("#contactInformationForm");
			contactInformationForm.hide();
			var contractsList = $("#contractsList");
			contractsList.hide();
		});

		$(function() {
			$("#authenticationForm").submit(function(event) {
				console.log('Dans authent');
				event.preventDefault();
				var user = $("#user").val();
				var pwd = $("#pwd").val();
				var errorAuthentMessage = $("#errorAuthentMessage");
				var errorAuthent = $("#errorAuthent");
				errorAuthent.hide();
				$("#messageAuthent").hide();

				console.log('User : ' + user);
				console.log('Pwd : ' + pwd);
				if (user.length == 0 || pwd.length == 0) {
					errorAuthentMessage.text("User and Password fields are required.");
					errorAuthent.show();
				} else {
					$.ajax({
						url: event.target.action,
						method: event.target.method,
						data: JSON.stringify({
							user: user,
							pwd: pwd,
						}),
						contentType: "application/json; charset=utf-8",
						dataType: "json",
						success: function(data) {
							console.log('data:'+JSON.stringify(data));
							$("#messageAuthentMessage").text("Authentication success !");
							$("#messageAuthent").show();
							var authenticationForm = $("#authenticationForm");
							authenticationForm.delay(800).slideUp(300);
							initAndShowContactForm($("#contactInformationForm"), data);
							//var contactInformationForm = $("#contactInformationForm");
							//contactInformationForm.show().slideUp(300).fadeIn(400);
							//contactInformationForm.show().delay(1100).slideUp(300);
						},
						error: function(err) {
							errorAuthentMessage.text(err.responseJSON.error);
							errorAuthent.show();
						}
					})
				}
			});
		});

		function initAndShowContactForm($param, $data) {
			$param.delay(1100).fadeIn(400);
			$("#firstName").val($data.rows[0].firstname);
			$("#lastName").val($data.rows[0].lastname);
			$("#email").val($data.rows[0].email);
			$("#phone").val($data.rows[0].phone);
			contactId = $data.rows[0].sfid;
			console.log('ContactId:'+contactId);
			// then show Contract List
			var contractsList = $("#contractsList");
			//contractsList.show();
			contractsList.delay(1200).fadeIn(400);
			var messageGetContracts = $("#messageGetContracts");
			var errorGetContracts = $("#errorGetContracts");
			messageGetContracts.hide();
			errorGetContracts.hide();
		}

		$(function() {
			$("#contactInformationForm").submit(function(event) {
				console.log('Dans phone');
				event.preventDefault();

				var errorMessage = $("#errorMessage");
				var error = $("#error");
				error.hide();

				$("#message").hide();

				var firstName = $("#firstName").val();
				console.log('FirstName : ' + firstName);
				var lastName = $("#lastName").val();
				var email = $("#email").val();
				var phone = $("#phone").val();

				if (firstName.length == 0 || lastName.length == 0 || email.length == 0 || phone.length == 0) {
					errorMessage.text("All of the fields are required.");
					error.show();
				}
				else {
					$.ajax({
						url: event.target.action,
						method: event.target.method,
						data: JSON.stringify({
							firstName: firstName,
							lastName: lastName,
							email: email,
							phone: phone
						}),
						contentType: "application/json; charset=utf-8",
						dataType: "json",
						success: function(data) {
							/*$("#firstName").val("");
							$("#lastName").val("");
							$("#email").val("");
							$("#phone").val("");*/
							$("#messageMessage").text("Record updated!");
							$("#message").show();
						},
						error: function(err) {
							errorMessage.text(err.responseJSON.error);
							error.show();
						}
					})
				}
			});
		});

		$(document).on("click", "#buttonGetContracts", function(event) {
			event.preventDefault();
			var messageGetContractsMessage = $("#messageGetContractsMessage");
			var errorGetContractsMessage = $("#errorGetContractsMessage");
			console.log('Dans contracsList via button');
			if (contactId != undefined && contactId != "") {
				$.ajax({
					url: "/contracts",
					method: "post",
					data: JSON.stringify({
						contactId: contactId,
					}),
					contentType: "application/json; charset=utf-8",
					dataType: "json",
					success: function(data) {
						console.log('data:'+JSON.stringify(data));
						var messageGetContractsMessage = $("#messageGetContractsMessage");
						messageGetContractsMessage.text("Success");
						var messageGetContracts = $("#messageGetContracts");
						messageGetContracts.show();
					},
					error: function(err) {
						errorGetContractsMessage.text(err.responseJSON.error);
						errorGetContractsMessage.show();
					}
				})
			}
		});

	</script>
</head>
<body>
	<nav class="navbar navbar-inverse navbar-fixed-top">
		<div class="container">
			<div class="navbar-header">
				<a class="navbar-brand" href="/">Mobile App LEGARANT</a>
			</div>
		</div>
	</nav>

	<div class="container text-center">
		<form id="authenticationForm" action="/contact/authent" method="post" style="width: 500px">
			<div class="panel panel-default">
				<div class="panel-heading">
					<h3 class="panel-title">Authentication</h3>
				</div>
				<div class="panel-body">
					<div class="form-group">
						<label for="user">Email</label>
						<input type="email" class="form-control" id="user" placeholder="Enter your email" required>
					</div>
					<div class="form-group">
						<label for="pwd">Password</label>
						<input type="password" class="form-control" id="pwd" placeholder="Enter your password" required>
					</div>
				</div>
				<div class="panel-footer">
					<div id="messageAuthent" class="alert alert-info" role="alert" style="display: none;">
						<span class="glyphicon glyphicon-ok" aria-hidden="true"></span>
						<span id="messageAuthentMessage"></span>
					</div>
					<div id="errorAuthent" class="alert alert-danger" role="alert" style="display: none;">
						<span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
						<span class="sr-only">Error:</span>
						<span id="errorAuthentMessage"></span>
					</div>
					<button type="submit" class="btn btn-primary">Validate</button>
				</div>
			</div>
		</form>

		<form id="contactInformationForm" action="/update" method="post" style="width: 500px">
			<div class="panel panel-default">
				<div class="panel-heading">
					<h3 class="panel-title">Update Your Contact Information</h3>
				</div>
				<div class="panel-body">
					<div class="form-group">
						<label for="firstName">First Name</label>
						<input type="text" class="form-control" id="firstName" placeholder="For verification" readonly>
					</div>
					<div class="form-group">
						<label for="lastName">Last Name</label>
						<input type="text" class="form-control" id="lastName" placeholder="For verification" readonly>
					</div>
					<div class="form-group">
						<label for="email">Email</label>
						<input type="email" class="form-control" id="email" placeholder="For verification" required>
					</div>
					<div class="form-group">
						<label for="phone">Phone</label>
						<input type="tel" class="form-control" id="phone" placeholder="New Phone Number" required>
					</div>
				</div>
				<div class="panel-footer">
					<div id="message" class="alert alert-info" role="alert" style="display: none;">
						<span class="glyphicon glyphicon-ok" aria-hidden="true"></span>
						<span id="messageMessage"></span>
					</div>
					<div id="error" class="alert alert-danger" role="alert" style="display: none;">
						<span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
						<span class="sr-only">Error:</span>
						<span id="errorMessage"></span>
					</div>
					<button type="submit" class="btn btn-primary">Update Contact Information</button>
				</div>
			</div>
		</form>

		<div id="contractsList" class="panel panel-default" style="width: 500px">
			<div class="panel-heading">
				<h3 class="panel-title">Contracts List</h3>
			</div>
			<div class="panel-body">
				<table class="table">
					<thead>
						<th scope="col">Contract Name</th>
						<th scope="col">Product</th>
					</thead>
				</table>
			</div>
			<div class="panel-footer">
				<div id="messageGetContracts" class="alert alert-info" role="alert" style="display: none;">
					<span class="glyphicon glyphicon-ok" aria-hidden="true"></span>
					<span id="messageGetContractsMessage"></span>
				</div>
				<div id="errorGetContracts" class="alert alert-danger" role="alert" style="display: none;">
					<span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
					<span class="sr-only">Error:</span>
					<span id="errorGetContractsMessage"></span>
				</div>
				<button type="button" id="buttonGetContracts" class="btn btn-primary">Retrieve contracts</button>
			</div>
		</div>
	</div>
</body>
</html>